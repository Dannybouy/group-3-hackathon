# Copyright 2024 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# apiVersion: apps/v1
# kind: Deployment
# metadata:
#   name: userservice
# spec:
#   selector:
#     matchLabels:
#       app: userservice
#   template:
#     metadata:
#       labels:
#         app: userservice
#     spec:
#       serviceAccountName: boa-ksa
#       terminationGracePeriodSeconds: 5
#       containers:
#       - name: userservice
#         image: gcr.io/bank-of-anthos-ci/userservice:v0.5.11@sha256:1559cbd3a9c937c84d067c5599e38c68fb4357215fd9d8de9c80ae81bbba863a
#         volumeMounts:
#         - name: keys
#           mountPath: "/root/.ssh"
#           readOnly: true
#         ports:
#         - name: http-server
#           containerPort: 8080
#         env:
#         - name: VERSION
#           value: "v0.5.11"
#         - name: PORT
#           value: "8080"
#         - name: ENABLE_TRACING
#           value: "true"
#         - name: TOKEN_EXPIRY_SECONDS
#           value: "3600"
#         - name: PRIV_KEY_PATH
#           value: "/root/.ssh/privatekey"
#         # Valid levels are debug, info, warning, error, critical. If no valid level is set, gunicorn will default to info.
#         - name: LOG_LEVEL
#           value: "info"
#         envFrom:
#         - configMapRef:
#             name: environment-config
#         - configMapRef:
#             name: accounts-db-config
#         readinessProbe:
#           httpGet:
#             path: /ready
#             port: 8080
#           initialDelaySeconds: 10
#           periodSeconds: 5
#           timeoutSeconds: 10
#         resources:
#           requests:
#             cpu: 100m
#             memory: 64Mi
#           limits:
#             cpu: 500m
#             memory: 256Mi
#       - name: cloudsql-proxy
#         resources:
#           limits:
#             cpu: "200m"
#             memory: "100Mi"
#         image: gcr.io/cloudsql-docker/gce-proxy:1.37.5@sha256:026f4f0d8a09507fa0619a577a2542e5344d2e8962c3e38dd1c0c585125fa471
#         env:
#         - name: CONNECTION_NAME
#           valueFrom:
#             secretKeyRef:
#               name: cloud-sql-admin
#               key: connectionName
#         command: ["/cloud_sql_proxy",
#                   "-instances=$(CONNECTION_NAME)=tcp:5432"]
#         securityContext:
#           runAsNonRoot: true
#       volumes:
#       - name: keys
#         secret:
#           secretName: jwt-key
#           items:
#           - key: jwtRS256.key
#             path: privatekey
#           - key: jwtRS256.key.pub
#             path: publickey
# ---
# apiVersion: v1
# kind: Service
# metadata:
#   name: userservice
# spec:
#   type: ClusterIP
#   selector:
#     app: userservice
#   ports:
#   - name: http
#     port: 8080
#     targetPort: 8080

apiVersion: apps/v1
kind: Deployment
metadata:
  name: userservice
  labels:
    application: bank-of-anthos
    environment: development
    team: accounts
    tier: backend
spec:
  selector:
    matchLabels:
      app: userservice
      application: bank-of-anthos
      environment: development
      team: accounts
      tier: backend
  template:
    metadata:
      annotations:
        proxy.istio.io/config: '{ "holdApplicationUntilProxyStarts": true }'
      labels:
        app: userservice
        application: bank-of-anthos
        environment: development
        team: accounts
        tier: backend
    spec:
      serviceAccountName: boa-ksa
      terminationGracePeriodSeconds: 5
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
        - name: userservice
          image: gcr.io/bank-of-anthos-ci/userservice:v0.5.11@sha256:1559cbd3a9c937c84d067c5599e38c68fb4357215fd9d8de9c80ae81bbba863a
          ports:
            - name: http-server
              containerPort: 8080
          env:
            - name: VERSION
              value: "v0.5.11"
            - name: PORT
              value: "8080"
            - name: ENABLE_TRACING
              value: "true"
            - name: TOKEN_EXPIRY_SECONDS
              value: "3600"
            - name: PRIV_KEY_PATH
              value: "/root/.ssh/privatekey"
            - name: LOG_LEVEL
              value: "info"
            - name: EMAIL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: email-credentials
                  key: password
          envFrom:
            - configMapRef:
                name: environment-config
            - configMapRef:
                name: accounts-db-config
            - configMapRef:
                name: email-config
            - secretRef:
                name: email-credentials
                optional: false
          readinessProbe:
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 10
          resources:
            requests:
              cpu: 260m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 256Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - all
            privileged: false
            readOnlyRootFilesystem: true
          volumeMounts:
            - name: keys
              mountPath: "/root/.ssh"
              readOnly: true
            - name: tmp
              mountPath: /tmp
        - name: cloudsql-proxy
          image: gcr.io/cloudsql-docker/gce-proxy:1.37.5@sha256:026f4f0d8a09507fa0619a577a2542e5344d2e8962c3e38dd1c0c585125fa471
          env:
            - name: CONNECTION_NAME
              valueFrom:
                secretKeyRef:
                  name: cloud-sql-admin
                  key: connectionName
          command: ["/cloud_sql_proxy", "-instances=$(CONNECTION_NAME)=tcp:5432"]
          resources:
            limits:
              cpu: 200m
              memory: 100Mi
          securityContext:
            runAsNonRoot: true
      volumes:
        - name: keys
          secret:
            secretName: jwt-key
            items:
              - key: jwtRS256.key
                path: privatekey
              - key: jwtRS256.key.pub
                path: publickey
        - name: tmp
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: userservice
  labels:
    application: bank-of-anthos
    environment: development
    team: accounts
    tier: backend
spec:
  type: ClusterIP
  selector:
    app: userservice
    application: bank-of-anthos
    environment: development
    team: accounts
    tier: backend
  ports:
    - name: http
      port: 8080
      targetPort: 8080

